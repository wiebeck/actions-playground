name: playground2
on: push
env:
  IMAGE_BASENAME: 'my-app'
jobs:
  experiment:
    runs-on: ubuntu-latest
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJSON(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJSON(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJSON(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJSON(runner) }}
        run: echo "$RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJSON(strategy) }}
        run: echo "$STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJSON(matrix) }}
        run: echo "$MATRIX_CONTEXT"

      - name: Tag for master builds
        id: tags_master
        run:  |
          REF_ID="${GITHUB_REF}"
          REF_ID="${REF_ID#refs/}"
          REF_ID="${REF_ID#heads/}"
          echo "::set-output name=tags::foo/$IMAGE_BASENAME:${REF_ID}-${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:8}"
        shell: bash

      - name: Tag for semantic version
        id: tags_other
        uses: crazy-max/ghaction-docker-meta@v1
        with:
          images: foo/${{ env.IMAGE_BASENAME }}
          tag-latest: false
          tag-semver: |
            {{version}}
            {{major}}.{{minor}}
            {{major}}

      - name: Select right tags
        id: tags
        run: |
          if [[ ${GITHUB_REF} == *"refs/heads/${{ github.event.repository.default_branch }}"* ]]; then
            echo "::set-output name=tags::${{ steps.tags_master.outputs.tags }}"
          else
            echo "::set-output name=tags::${{ steps.tags_other.outputs.tags }}"
          fi
        shell: bash
